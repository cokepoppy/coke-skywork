# Skywork AI Agent 服务端系统调研报告

**项目名称**: Skywork AI Agent Backend System
**调研日期**: 2025-12-18
**调研目标**: 设计并实现基于 Express + TypeScript + MySQL 的 AI Agent 后端服务系统

---

## 一、项目背景与目标

### 1.1 项目背景

随着 AI 技术的快速发展,AI Agent 服务已成为企业和个人提升效率的重要工具。Skywork AI 作为一个综合性 AI 平台,需要构建一个稳定、可扩展、安全的后端服务系统,支持:

- 用户认证与授权 (Google OAuth 2.0)
- 点数消费与计费系统
- 订阅与充值功能
- AI 服务调用管理
- 使用数据统计与分析

### 1.2 项目目标

1. **用户体系**: 实现完整的用户注册、登录、权限管理
2. **计费系统**: 建立基于点数的消费模型,支持订阅和按量付费
3. **支付集成**: 集成主流支付方式 (Stripe, PayPal 等)
4. **API 管理**: 提供 RESTful API 供前端调用
5. **数据安全**: 确保用户数据和交易安全
6. **可扩展性**: 支持未来功能扩展和高并发场景

---

## 二、竞品分析

### 2.1 主流 AI 平台调研

#### OpenAI ChatGPT Plus
- **计费模式**:
  - 免费版: 限制访问频率
  - Plus 订阅: $20/月,无限访问 GPT-4
  - API 计费: 按 token 收费 ($0.03/1K tokens)
- **优势**:
  - 简单明了的订阅模式
  - 灵活的 API 计费
- **劣势**:
  - 免费版体验有限
  - 缺少点数预付费选项

#### Claude.ai (Anthropic)
- **计费模式**:
  - 免费版: 每日限额
  - Pro 订阅: $20/月
  - API 按使用量计费
- **优势**:
  - 更长的上下文窗口
  - 清晰的免费配额
- **劣势**:
  - 订阅价格较高

#### Gemini (Google)
- **计费模式**:
  - 免费使用 Gemini 1.5 Flash
  - Google One AI Premium: $19.99/月 (包含 2TB 存储)
  - API 按 token 计费
- **优势**:
  - 与 Google 生态深度集成
  - 免费版功能较强
- **劣势**:
  - 订阅捆绑其他服务

#### Midjourney
- **计费模式**:
  - 基础版: $10/月 (约 200 张图)
  - 标准版: $30/月 (无限放松模式)
  - Pro 版: $60/月 (隐私模式)
- **优势**:
  - 清晰的分级订阅
  - 提供免费试用
- **劣势**:
  - 仅支持订阅,无点数模式

### 2.2 计费模式对比

| 平台 | 免费模式 | 订阅模式 | 点数/按量付费 | 价格区间 |
|------|---------|---------|--------------|----------|
| ChatGPT | ✅ 限频 | ✅ $20/月 | ✅ API 计费 | $0-20+/月 |
| Claude | ✅ 每日限额 | ✅ $20/月 | ✅ API 计费 | $0-20+/月 |
| Gemini | ✅ Flash 免费 | ✅ $19.99/月 | ✅ API 计费 | $0-19.99/月 |
| Midjourney | ❌ | ✅ 分级订阅 | ❌ | $10-60/月 |
| Skywork AI | **推荐: ✅** | **推荐: ✅** | **推荐: ✅** | **灵活定价** |

### 2.3 功能特性对比

#### 用户认证
- **Google OAuth 2.0**: 业界标准,安全可靠,用户体验好
- **邮箱 + 密码**: 传统方式,需要额外实现找回密码、邮箱验证等
- **第三方登录**: GitHub, Microsoft, Apple 等

**推荐方案**: Google OAuth 2.0 为主,邮箱密码为辅

#### 点数系统设计
- **OpenAI 模式**: Token 计费,精确到每次请求
- **Midjourney 模式**: 按生成次数计费
- **混合模式**: 基础订阅 + 额外点数包

**推荐方案**: 混合模式 - 订阅用户获得月度点数配额,可额外购买点数包

---

## 三、技术选型调研

### 3.1 后端框架对比

#### Express.js
- **优势**:
  - 轻量灵活,中间件生态丰富
  - TypeScript 支持良好
  - 社区活跃,资料丰富
  - 适合快速迭代
- **劣势**:
  - 需要手动配置较多
  - 缺少内置 ORM

#### NestJS
- **优势**:
  - 开箱即用的企业级框架
  - 原生 TypeScript 支持
  - 模块化架构,易于维护
  - 内置依赖注入
- **劣势**:
  - 学习曲线较陡
  - 项目体积较大

#### Fastify
- **优势**:
  - 性能优异 (比 Express 快 2 倍)
  - 现代化设计
  - 原生 TypeScript 支持
- **劣势**:
  - 生态相对较小
  - 社区资源少

**选型结论**: **Express + TypeScript**
- 理由: 快速开发,生态成熟,团队熟悉度高,适合中小型项目

### 3.2 数据库选型

#### MySQL
- **优势**:
  - 成熟稳定,事务支持完善
  - 适合关系型数据 (用户、订单、交易记录)
  - 索引性能优秀
  - 部署运维成熟
- **使用场景**:
  - 用户信息
  - 订单记录
  - 点数交易
  - 订阅管理

#### Redis
- **优势**:
  - 高性能内存数据库
  - 支持多种数据结构
  - 适合缓存和会话管理
- **使用场景**:
  - Session 存储
  - API 请求限流
  - 热点数据缓存

#### MongoDB
- **优势**:
  - 灵活的文档模型
  - 水平扩展能力强
- **使用场景**:
  - AI 对话历史
  - PPT 生成记录
  - 日志数据

**选型结论**: **MySQL (主) + Redis (缓存) + MongoDB (日志)**

### 3.3 ORM/数据库工具

#### TypeORM
- **优势**:
  - TypeScript 原生支持
  - 支持多种数据库
  - 装饰器语法优雅
  - 迁移管理完善
- **劣势**:
  - 性能相对 Prisma 略低

#### Prisma
- **优势**:
  - 类型安全,自动生成类型
  - 优秀的开发体验
  - 性能优异
  - 可视化数据库管理
- **劣势**:
  - 相对较新,部分功能不够成熟

#### Sequelize
- **优势**:
  - 老牌 ORM,生态成熟
  - 支持多数据库
- **劣势**:
  - TypeScript 支持一般
  - API 设计较老

**选型结论**: **Prisma**
- 理由: 类型安全,开发体验好,性能优秀

### 3.4 身份认证

#### Passport.js
- **优势**:
  - 支持 500+ 认证策略
  - Express 集成完善
  - Google OAuth 策略成熟
- **劣势**:
  - 配置相对复杂

#### JWT (jsonwebtoken)
- **优势**:
  - 无状态,易于扩展
  - 跨域支持好
- **劣势**:
  - 无法撤销 token (需要黑名单机制)

**选型结论**: **Passport.js (Google OAuth) + JWT (会话管理)**

### 3.5 支付集成

#### Stripe
- **优势**:
  - API 设计优秀
  - 文档完善
  - 支持订阅和一次性支付
  - 安全性高
  - 支持全球主流支付方式
- **劣势**:
  - 国内支付支持有限
  - 手续费相对较高 (2.9% + $0.30)

#### PayPal
- **优势**:
  - 全球用户基础大
  - 支持多币种
- **劣势**:
  - API 复杂度高
  - 用户体验一般

#### 国内支付 (支付宝/微信支付)
- **优势**:
  - 国内用户习惯
  - 到账快
- **劣势**:
  - 需要企业资质
  - API 文档质量参差不齐

**选型结论**: **Stripe (主) + PayPal (备选)**
- 理由: 面向全球用户,Stripe 开发体验最佳

---

## 四、业务需求分析

### 4.1 用户系统

#### 核心功能
1. **Google OAuth 登录**
   - 一键登录,无需注册
   - 获取用户头像、邮箱、姓名
   - 自动创建用户账户

2. **用户信息管理**
   - 个人资料编辑
   - 偏好设置
   - 安全设置

3. **权限管理**
   - 普通用户
   - 订阅用户
   - 管理员

#### 数据结构
```typescript
interface User {
  id: string;              // UUID
  googleId: string;        // Google OAuth ID
  email: string;           // 邮箱
  name: string;            // 姓名
  avatar: string;          // 头像 URL
  role: 'user' | 'subscriber' | 'admin';
  credits: number;         // 当前点数
  createdAt: Date;
  updatedAt: Date;
}
```

### 4.2 点数系统

#### 点数消费规则
| 功能 | 消耗点数 | 说明 |
|------|---------|------|
| AI 对话 (Flash) | 1 点/次 | 普通对话 |
| AI 对话 (Pro) | 5 点/次 | 高级对话 |
| PPT 生成 | 10 点/次 | 单页 PPT |
| PPT 分析编辑 | 20 点/次 | Vision + 编辑 |
| 图片生成 | 15 点/次 | AI 图片 |

#### 点数获取方式
1. **新用户赠送**: 100 点 (体验用)
2. **每日签到**: 5 点/天
3. **订阅用户**: 500 点/月
4. **购买点数包**:
   - 小包: 100 点 = $5
   - 中包: 500 点 = $20 (省 $5)
   - 大包: 1500 点 = $50 (省 $25)

### 4.3 订阅系统

#### 订阅计划
| 计划 | 价格 | 包含点数 | 特权 |
|------|------|---------|------|
| Free | $0 | 100 点 (首次) | 基础功能 |
| Basic | $9.99/月 | 500 点/月 | 优先队列 |
| Pro | $19.99/月 | 1500 点/月 | 所有功能 + 历史记录 |
| Team | $49.99/月 | 5000 点/月 | 多用户 + 数据导出 |

#### 订阅特性
- **自动续订**: Stripe Subscription
- **取消订阅**: 可随时取消,剩余点数保留
- **升级/降级**: 按比例计算差价
- **发票管理**: 自动生成发票

### 4.4 支付系统

#### 支付流程
```
用户选择套餐
  → 创建支付订单
  → 跳转 Stripe Checkout
  → 支付成功回调
  → 更新用户点数/订阅状态
  → 发送确认邮件
```

#### 安全措施
1. **Webhook 验证**: Stripe Signature 验证
2. **幂等性**: 订单号防重复
3. **交易日志**: 完整记录所有交易
4. **退款管理**: 7 天无理由退款

---

## 五、技术风险评估

### 5.1 高风险项

#### 支付安全
- **风险**: 支付信息泄露,欺诈交易
- **应对**:
  - 使用 Stripe 托管支付,不存储卡信息
  - HTTPS 加密传输
  - Webhook 签名验证
  - 异常交易监控

#### 点数并发问题
- **风险**: 高并发下点数扣减不准确
- **应对**:
  - 数据库事务锁
  - Redis 分布式锁
  - 点数扣减日志审计

#### OAuth 安全
- **风险**: CSRF 攻击,token 泄露
- **应对**:
  - State 参数验证
  - Token 短期有效
  - Refresh Token 轮转

### 5.2 中风险项

#### 数据库性能
- **风险**: 高并发下数据库压力大
- **应对**:
  - Redis 缓存热点数据
  - 数据库读写分离
  - 索引优化

#### API 限流
- **风险**: 恶意请求消耗资源
- **应对**:
  - 基于 IP 和用户的限流
  - Redis 计数器
  - 订阅用户更高限额

---

## 六、开发成本估算

### 6.1 开发工作量 (人天)

| 模块 | 工作量 | 优先级 |
|------|-------|--------|
| 基础架构搭建 | 3 天 | P0 |
| Google OAuth 登录 | 2 天 | P0 |
| 用户管理系统 | 3 天 | P0 |
| 点数系统 | 4 天 | P0 |
| 订阅系统 | 5 天 | P1 |
| Stripe 支付集成 | 5 天 | P1 |
| API 开发与测试 | 7 天 | P0 |
| 管理后台 | 5 天 | P2 |
| 文档编写 | 2 天 | P1 |
| **总计** | **36 天** | - |

### 6.2 技术栈成本

| 服务 | 免费额度 | 付费成本 | 说明 |
|------|---------|---------|------|
| 服务器 (AWS EC2) | 750h/月 (首年) | $10-50/月 | t3.small |
| 数据库 (AWS RDS) | 750h/月 (首年) | $15-40/月 | MySQL t3.micro |
| Redis (AWS ElastiCache) | - | $15/月 | cache.t3.micro |
| Stripe | 免费 | 2.9% + $0.30/笔 | 交易手续费 |
| 域名 + SSL | - | $15/年 | - |
| **总计 (月)** | **首年免费** | **$55-120** | - |

---

## 七、调研结论与建议

### 7.1 技术栈最终选型

```
前端: React + TypeScript + Vite
后端: Express + TypeScript + Prisma
数据库: MySQL + Redis + MongoDB
认证: Passport.js (Google OAuth) + JWT
支付: Stripe
部署: AWS / Vercel / Railway
```

### 7.2 开发优先级

**Phase 1 (MVP - 2周)**
- ✅ Google OAuth 登录
- ✅ 基础用户系统
- ✅ 点数系统 (充值、扣减、查询)
- ✅ 简单的点数购买 (Stripe Checkout)

**Phase 2 (完整版 - 4周)**
- ✅ 订阅系统 (月度/年度)
- ✅ Stripe Subscription 集成
- ✅ 使用历史记录
- ✅ 管理后台

**Phase 3 (优化版 - 6周+)**
- ✅ PayPal 备选支付
- ✅ 推荐奖励系统
- ✅ 企业团队功能
- ✅ 高级数据分析

### 7.3 关键成功因素

1. **用户体验**: 登录流程简单,支付体验流畅
2. **定价策略**: 免费额度吸引用户,订阅价格有竞争力
3. **技术稳定性**: 高可用性,快速响应
4. **数据安全**: 用户信息和支付安全

### 7.4 风险应对建议

1. **技术风险**: 采用成熟技术栈,避免过度创新
2. **安全风险**: 使用第三方托管支付,定期安全审计
3. **成本风险**: 使用云服务免费额度,按需扩展
4. **运营风险**: 提供免费试用,降低用户决策门槛

---

## 八、参考资料

1. **Stripe 文档**: https://stripe.com/docs
2. **Google OAuth 2.0**: https://developers.google.com/identity/protocols/oauth2
3. **Prisma 文档**: https://www.prisma.io/docs
4. **Express.js 最佳实践**: https://expressjs.com/en/advanced/best-practice-security.html
5. **TypeScript 手册**: https://www.typescriptlang.org/docs/

---

**报告编写**: Claude AI
**审核状态**: 待审核
**下一步行动**: 编写详细技术方案

# Skywork AI Agent 服务端技术方案

**版本**: v1.0
**日期**: 2025-12-18
**技术栈**: Express + TypeScript + MySQL + Prisma + Redis

---

## 目录

1. [系统架构设计](#一系统架构设计)
2. [数据库设计](#二数据库设计)
3. [API 接口设计](#三api-接口设计)
4. [核心功能实现](#四核心功能实现)
5. [安全方案](#五安全方案)
6. [部署方案](#六部署方案)
7. [开发规范](#七开发规范)

---

## 一、系统架构设计

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    客户端 (React + TS)                   │
└──────────────────────┬──────────────────────────────────┘
                       │ HTTPS
                       ↓
┌─────────────────────────────────────────────────────────┐
│              负载均衡 (Nginx / AWS ALB)                  │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ↓                              ↓
┌──────────────┐              ┌──────────────┐
│ Express 实例1 │              │ Express 实例2 │
│  (Node.js)   │              │  (Node.js)   │
└──────┬───────┘              └──────┬───────┘
       │                              │
       └──────────────┬───────────────┘
                      ↓
        ┌─────────────────────────┐
        │   数据层 (Data Layer)    │
        │                         │
        │  ┌──────────────────┐  │
        │  │   MySQL (RDS)    │  │ 用户、订单、交易
        │  └──────────────────┘  │
        │                         │
        │  ┌──────────────────┐  │
        │  │ Redis (ElastiCache)│ Session、限流、缓存
        │  └──────────────────┘  │
        │                         │
        │  ┌──────────────────┐  │
        │  │   MongoDB Atlas  │  │ AI对话历史、日志
        │  └──────────────────┘  │
        └─────────────────────────┘
                      ↓
        ┌─────────────────────────┐
        │   外部服务 (External)    │
        │                         │
        │  • Google OAuth 2.0     │
        │  • Stripe Payment       │
        │  • Gemini AI API        │
        │  • SendGrid (Email)     │
        └─────────────────────────┘
```

### 1.2 技术栈明细

#### 后端框架
```typescript
// package.json
{
  "dependencies": {
    "express": "^4.19.0",
    "typescript": "^5.3.0",
    "@types/express": "^4.17.21",

    // 数据库
    "@prisma/client": "^5.8.0",
    "prisma": "^5.8.0",
    "redis": "^4.6.0",
    "mongoose": "^8.1.0",

    // 认证
    "passport": "^0.7.0",
    "passport-google-oauth20": "^2.0.0",
    "jsonwebtoken": "^9.0.2",
    "bcrypt": "^5.1.1",

    // 支付
    "stripe": "^14.12.0",

    // 工具
    "dotenv": "^16.4.0",
    "cors": "^2.8.5",
    "helmet": "^7.1.0",
    "express-rate-limit": "^7.1.5",
    "express-validator": "^7.0.1",
    "winston": "^3.11.0"
  }
}
```

### 1.3 项目结构

```
skywork-backend/
├── src/
│   ├── config/              # 配置文件
│   │   ├── database.ts      # 数据库配置
│   │   ├── redis.ts         # Redis 配置
│   │   ├── passport.ts      # Passport 配置
│   │   └── stripe.ts        # Stripe 配置
│   ├── controllers/         # 控制器层
│   │   ├── auth.controller.ts
│   │   ├── user.controller.ts
│   │   ├── credit.controller.ts
│   │   ├── subscription.controller.ts
│   │   └── payment.controller.ts
│   ├── services/            # 业务逻辑层
│   │   ├── auth.service.ts
│   │   ├── user.service.ts
│   │   ├── credit.service.ts
│   │   ├── subscription.service.ts
│   │   └── payment.service.ts
│   ├── models/              # Prisma 模型
│   │   └── schema.prisma
│   ├── middleware/          # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── validation.middleware.ts
│   │   ├── rateLimit.middleware.ts
│   │   └── error.middleware.ts
│   ├── routes/              # 路由
│   │   ├── auth.routes.ts
│   │   ├── user.routes.ts
│   │   ├── credit.routes.ts
│   │   ├── subscription.routes.ts
│   │   └── payment.routes.ts
│   ├── types/               # TypeScript 类型
│   │   ├── user.types.ts
│   │   ├── credit.types.ts
│   │   └── payment.types.ts
│   ├── utils/               # 工具函数
│   │   ├── logger.ts
│   │   ├── errors.ts
│   │   └── helpers.ts
│   ├── app.ts               # Express 应用
│   └── server.ts            # 服务器入口
├── prisma/
│   ├── schema.prisma        # Prisma schema
│   └── migrations/          # 数据库迁移
├── tests/                   # 测试文件
├── .env.example             # 环境变量示例
├── tsconfig.json            # TypeScript 配置
└── package.json
```

---

## 二、数据库设计

### 2.1 Prisma Schema 设计

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============ 用户表 ============
model User {
  id            String   @id @default(uuid())
  googleId      String?  @unique
  email         String   @unique
  name          String
  avatar        String?
  role          Role     @default(USER)
  credits       Int      @default(100)  // 当前点数
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关联关系
  sessions      Session[]
  creditLogs    CreditLog[]
  subscriptions Subscription[]
  payments      Payment[]
  usageLogs     UsageLog[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

enum Role {
  USER
  SUBSCRIBER
  ADMIN
}

// ============ 会话表 (JWT 黑名单) ============
model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============ 点数变动日志 ============
model CreditLog {
  id          String      @id @default(uuid())
  userId      String
  amount      Int                    // 变动数量 (正数=增加, 负数=扣减)
  balance     Int                    // 变动后余额
  type        CreditType
  description String?
  metadata    Json?                  // 额外信息 (如订单ID、功能类型)
  createdAt   DateTime    @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("credit_logs")
}

enum CreditType {
  SIGNUP_BONUS      // 注册赠送
  DAILY_CHECKIN     // 每日签到
  PURCHASE          // 购买点数包
  SUBSCRIPTION      // 订阅充值
  USAGE             // 使用消耗
  REFUND            // 退款
  ADMIN_ADJUST      // 管理员调整
}

// ============ 订阅表 ============
model Subscription {
  id                String              @id @default(uuid())
  userId            String
  plan              SubscriptionPlan
  status            SubscriptionStatus
  stripeCustomerId  String?             @unique
  stripeSubscriptionId String?          @unique
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  UNPAID
}

// ============ 支付记录 ============
model Payment {
  id               String        @id @default(uuid())
  userId           String
  amount           Int                  // 金额 (分)
  currency         String        @default("usd")
  credits          Int                  // 购买的点数
  type             PaymentType
  status           PaymentStatus
  stripePaymentId  String?       @unique
  stripeInvoiceId  String?
  metadata         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

enum PaymentType {
  ONE_TIME          // 一次性购买点数包
  SUBSCRIPTION      // 订阅付款
  REFUND            // 退款
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============ 使用日志 ============
model UsageLog {
  id          String   @id @default(uuid())
  userId      String
  feature     String             // 功能名称 (如 "chat-flash", "ppt-generate")
  credits     Int                // 消耗点数
  metadata    Json?              // 额外信息 (如对话ID、PPT ID)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([feature])
  @@index([createdAt])
  @@map("usage_logs")
}

// ============ 点数包配置 ============
model CreditPackage {
  id          String   @id @default(uuid())
  name        String
  credits     Int
  price       Int                // 价格 (分)
  currency    String   @default("usd")
  discount    Int      @default(0)  // 折扣百分比
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("credit_packages")
}
```

### 2.2 数据库索引策略

```sql
-- 高频查询优化
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_user_google_id ON users(googleId);
CREATE INDEX idx_credit_log_user_time ON credit_logs(userId, createdAt DESC);
CREATE INDEX idx_payment_user_status ON payments(userId, status);
CREATE INDEX idx_usage_log_composite ON usage_logs(userId, feature, createdAt);

-- 唯一索引
CREATE UNIQUE INDEX idx_session_token ON sessions(token);
CREATE UNIQUE INDEX idx_subscription_stripe ON subscriptions(stripeSubscriptionId);
```

### 2.3 Redis 数据结构

```typescript
// Redis Key 设计

// 1. 用户会话
`session:${userId}` → JWT Token (String, TTL: 7天)

// 2. API 限流
`ratelimit:${userId}:${endpoint}` → 计数器 (String, TTL: 1分钟)

// 3. 用户点数缓存
`credits:${userId}` → 点数余额 (String, TTL: 5分钟)

// 4. 分布式锁 (点数扣减)
`lock:credit:${userId}` → 锁标识 (String, TTL: 10秒)

// 5. 在线用户统计
`online:users` → Set of userIds (Set)

// 6. 功能开关
`feature:${featureName}` → enabled/disabled (String)
```

---

## 三、API 接口设计

### 3.1 认证相关 API

#### 1. Google OAuth 登录

**Endpoint**: `GET /api/auth/google`
**说明**: 重定向到 Google OAuth 登录页面

**响应**: 302 重定向到 Google

---

**Endpoint**: `GET /api/auth/google/callback`
**说明**: Google OAuth 回调处理

**查询参数**:
```typescript
{
  code: string;    // Google 授权码
  state: string;   // CSRF 防护
}
```

**成功响应**: 302 重定向到前端并携带 token
```
https://app.skywork.ai/auth/callback?token=eyJhbGc...&refreshToken=dGh...
```

#### 2. 刷新 Token

**Endpoint**: `POST /api/auth/refresh`
**请求体**:
```typescript
{
  refreshToken: string;
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    token: string;
    refreshToken: string;
    expiresIn: number;
  }
}
```

#### 3. 登出

**Endpoint**: `POST /api/auth/logout`
**Headers**: `Authorization: Bearer <token>`

**成功响应**: 200
```typescript
{
  success: true,
  message: "Logged out successfully"
}
```

### 3.2 用户相关 API

#### 1. 获取当前用户信息

**Endpoint**: `GET /api/users/me`
**Headers**: `Authorization: Bearer <token>`

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    id: string;
    email: string;
    name: string;
    avatar: string;
    role: "USER" | "SUBSCRIBER" | "ADMIN";
    credits: number;
    subscription?: {
      plan: "FREE" | "BASIC" | "PRO" | "TEAM";
      status: "ACTIVE" | "CANCELED";
      currentPeriodEnd: string;
    };
    createdAt: string;
  }
}
```

#### 2. 更新用户信息

**Endpoint**: `PATCH /api/users/me`
**Headers**: `Authorization: Bearer <token>`
**请求体**:
```typescript
{
  name?: string;
  avatar?: string;
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: { /* 更新后的用户信息 */ }
}
```

### 3.3 点数相关 API

#### 1. 获取点数余额

**Endpoint**: `GET /api/credits/balance`
**Headers**: `Authorization: Bearer <token>`

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    credits: number;
    lastUpdated: string;
  }
}
```

#### 2. 获取点数变动历史

**Endpoint**: `GET /api/credits/history`
**Headers**: `Authorization: Bearer <token>`
**查询参数**:
```typescript
{
  page?: number;      // 默认 1
  limit?: number;     // 默认 20
  type?: CreditType;  // 可选筛选
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    logs: Array<{
      id: string;
      amount: number;
      balance: number;
      type: CreditType;
      description: string;
      createdAt: string;
    }>;
    pagination: {
      total: number;
      page: number;
      limit: number;
      totalPages: number;
    };
  }
}
```

#### 3. 扣减点数 (内部使用)

**Endpoint**: `POST /api/credits/deduct`
**Headers**: `Authorization: Bearer <token>` (Service Token)
**请求体**:
```typescript
{
  userId: string;
  amount: number;
  feature: string;
  metadata?: object;
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    newBalance: number;
    transactionId: string;
  }
}
```

**错误响应**: 402 (余额不足)
```typescript
{
  success: false,
  error: {
    code: "INSUFFICIENT_CREDITS",
    message: "Insufficient credits",
    required: 10,
    current: 5
  }
}
```

### 3.4 订阅相关 API

#### 1. 获取订阅计划列表

**Endpoint**: `GET /api/subscriptions/plans`

**成功响应**: 200
```typescript
{
  success: true,
  data: [
    {
      id: "basic",
      name: "Basic",
      price: 999,        // 9.99 美元 (分)
      interval: "month",
      credits: 500,
      features: ["优先队列", "客户支持"]
    },
    // ...更多计划
  ]
}
```

#### 2. 创建订阅

**Endpoint**: `POST /api/subscriptions/create`
**Headers**: `Authorization: Bearer <token>`
**请求体**:
```typescript
{
  planId: string;      // "basic" | "pro" | "team"
  paymentMethodId?: string;  // Stripe Payment Method ID
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    clientSecret: string;  // Stripe Client Secret for 3D Secure
    subscriptionId: string;
  }
}
```

#### 3. 取消订阅

**Endpoint**: `POST /api/subscriptions/cancel`
**Headers**: `Authorization: Bearer <token>`

**成功响应**: 200
```typescript
{
  success: true,
  message: "Subscription will be canceled at the end of current period",
  data: {
    cancelAt: string;  // ISO 8601
  }
}
```

#### 4. 恢复订阅

**Endpoint**: `POST /api/subscriptions/resume`
**Headers**: `Authorization: Bearer <token>`

**成功响应**: 200
```typescript
{
  success: true,
  message: "Subscription resumed successfully"
}
```

### 3.5 支付相关 API

#### 1. 获取点数包列表

**Endpoint**: `GET /api/payments/packages`

**成功响应**: 200
```typescript
{
  success: true,
  data: [
    {
      id: string;
      name: "小包";
      credits: 100;
      price: 500;       // 5.00 美元 (分)
      discount: 0;      // 无折扣
    },
    {
      id: string;
      name: "中包";
      credits: 500;
      price: 2000;      // 20.00 美元
      discount: 20;     // 20% 折扣
    },
    // ...更多
  ]
}
```

#### 2. 创建购买订单

**Endpoint**: `POST /api/payments/create`
**Headers**: `Authorization: Bearer <token>`
**请求体**:
```typescript
{
  packageId: string;
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    sessionId: string;         // Stripe Checkout Session ID
    checkoutUrl: string;       // 跳转到 Stripe Checkout 的 URL
  }
}
```

#### 3. Stripe Webhook

**Endpoint**: `POST /api/payments/webhook`
**Headers**: `stripe-signature: <signature>`
**请求体**: Stripe Event JSON

**处理事件**:
- `checkout.session.completed`: 支付成功,充值点数
- `invoice.payment_succeeded`: 订阅续费成功
- `customer.subscription.deleted`: 订阅取消

**响应**: 200 (确认收到)

### 3.6 使用统计 API

#### 1. 获取使用统计

**Endpoint**: `GET /api/usage/stats`
**Headers**: `Authorization: Bearer <token>`
**查询参数**:
```typescript
{
  startDate?: string;   // ISO 8601, 默认 30 天前
  endDate?: string;     // ISO 8601, 默认今天
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    totalUsage: number;        // 总消耗点数
    usageByFeature: {
      "chat-flash": 50,
      "chat-pro": 30,
      "ppt-generate": 100
    },
    dailyUsage: [
      { date: "2025-12-01", credits: 20 },
      { date: "2025-12-02", credits: 35 },
      // ...
    ]
  }
}
```

### 3.7 管理员 API

#### 1. 调整用户点数

**Endpoint**: `POST /api/admin/credits/adjust`
**Headers**: `Authorization: Bearer <admin-token>`
**请求体**:
```typescript
{
  userId: string;
  amount: number;      // 正数=增加, 负数=扣减
  reason: string;
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    newBalance: number;
  }
}
```

#### 2. 获取所有用户列表

**Endpoint**: `GET /api/admin/users`
**Headers**: `Authorization: Bearer <admin-token>`
**查询参数**:
```typescript
{
  page?: number;
  limit?: number;
  role?: Role;
  search?: string;    // 搜索 email 或 name
}
```

**成功响应**: 200
```typescript
{
  success: true,
  data: {
    users: Array<User>;
    pagination: { /* ... */ };
  }
}
```

---

## 四、核心功能实现

### 4.1 Google OAuth 登录流程

```typescript
// src/config/passport.ts

import passport from 'passport';
import { Strategy as GoogleStrategy } from 'passport-google-oauth20';
import { prisma } from './database';
import { generateTokens } from '../utils/jwt';

passport.use(
  new GoogleStrategy(
    {
      clientID: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      callbackURL: '/api/auth/google/callback',
      scope: ['profile', 'email'],
    },
    async (accessToken, refreshToken, profile, done) => {
      try {
        // 查找或创建用户
        let user = await prisma.user.findUnique({
          where: { googleId: profile.id },
        });

        if (!user) {
          // 新用户,创建账户并赠送初始点数
          user = await prisma.user.create({
            data: {
              googleId: profile.id,
              email: profile.emails![0].value,
              name: profile.displayName,
              avatar: profile.photos![0]?.value,
              credits: 100,  // 注册赠送 100 点
            },
          });

          // 记录点数变动
          await prisma.creditLog.create({
            data: {
              userId: user.id,
              amount: 100,
              balance: 100,
              type: 'SIGNUP_BONUS',
              description: '注册赠送',
            },
          });
        }

        return done(null, user);
      } catch (error) {
        return done(error as Error);
      }
    }
  )
);

// src/controllers/auth.controller.ts

export const googleCallback = async (req: Request, res: Response) => {
  const user = req.user as User;

  // 生成 JWT Token
  const { token, refreshToken } = generateTokens(user);

  // 存储 Session 到数据库
  await prisma.session.create({
    data: {
      userId: user.id,
      token,
      refreshToken,
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 天
    },
  });

  // 重定向到前端并携带 token
  res.redirect(
    `${process.env.FRONTEND_URL}/auth/callback?token=${token}&refreshToken=${refreshToken}`
  );
};
```

### 4.2 点数扣减逻辑 (带分布式锁)

```typescript
// src/services/credit.service.ts

import { prisma } from '../config/database';
import { redisClient } from '../config/redis';
import { AppError } from '../utils/errors';

export class CreditService {
  /**
   * 扣减用户点数 (带分布式锁)
   * @param userId 用户ID
   * @param amount 扣减数量
   * @param feature 功能标识
   * @param metadata 额外信息
   */
  async deductCredits(
    userId: string,
    amount: number,
    feature: string,
    metadata?: object
  ): Promise<{ newBalance: number; transactionId: string }> {
    const lockKey = `lock:credit:${userId}`;
    const lockValue = `${Date.now()}-${Math.random()}`;

    try {
      // 1. 获取分布式锁 (10秒超时)
      const acquired = await redisClient.set(lockKey, lockValue, {
        NX: true,
        EX: 10,
      });

      if (!acquired) {
        throw new AppError('系统繁忙,请稍后重试', 429);
      }

      // 2. 开启数据库事务
      const result = await prisma.$transaction(async (tx) => {
        // 2.1 查询当前余额 (加行锁)
        const user = await tx.user.findUnique({
          where: { id: userId },
          select: { credits: true },
        });

        if (!user) {
          throw new AppError('用户不存在', 404);
        }

        // 2.2 检查余额
        if (user.credits < amount) {
          throw new AppError('点数不足', 402, {
            required: amount,
            current: user.credits,
          });
        }

        // 2.3 扣减点数
        const updatedUser = await tx.user.update({
          where: { id: userId },
          data: { credits: { decrement: amount } },
        });

        // 2.4 记录变动日志
        const creditLog = await tx.creditLog.create({
          data: {
            userId,
            amount: -amount,
            balance: updatedUser.credits,
            type: 'USAGE',
            description: `使用功能: ${feature}`,
            metadata: metadata as any,
          },
        });

        // 2.5 记录使用日志
        await tx.usageLog.create({
          data: {
            userId,
            feature,
            credits: amount,
            metadata: metadata as any,
          },
        });

        return {
          newBalance: updatedUser.credits,
          transactionId: creditLog.id,
        };
      });

      // 3. 清除 Redis 缓存
      await redisClient.del(`credits:${userId}`);

      return result;
    } finally {
      // 4. 释放锁 (使用 Lua 脚本确保原子性)
      const script = `
        if redis.call("get", KEYS[1]) == ARGV[1] then
          return redis.call("del", KEYS[1])
        else
          return 0
        end
      `;
      await redisClient.eval(script, {
        keys: [lockKey],
        arguments: [lockValue],
      });
    }
  }

  /**
   * 充值点数
   */
  async addCredits(
    userId: string,
    amount: number,
    type: 'PURCHASE' | 'SUBSCRIPTION' | 'ADMIN_ADJUST',
    description: string,
    metadata?: object
  ): Promise<{ newBalance: number }> {
    const result = await prisma.$transaction(async (tx) => {
      const updatedUser = await tx.user.update({
        where: { id: userId },
        data: { credits: { increment: amount } },
      });

      await tx.creditLog.create({
        data: {
          userId,
          amount,
          balance: updatedUser.credits,
          type,
          description,
          metadata: metadata as any,
        },
      });

      return { newBalance: updatedUser.credits };
    });

    // 清除缓存
    await redisClient.del(`credits:${userId}`);

    return result;
  }
}
```

### 4.3 Stripe 支付集成

```typescript
// src/services/payment.service.ts

import Stripe from 'stripe';
import { prisma } from '../config/database';
import { CreditService } from './credit.service';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
});

const creditService = new CreditService();

export class PaymentService {
  /**
   * 创建点数购买 Checkout Session
   */
  async createCheckoutSession(userId: string, packageId: string) {
    // 1. 查询点数包信息
    const pkg = await prisma.creditPackage.findUnique({
      where: { id: packageId },
    });

    if (!pkg || !pkg.isActive) {
      throw new AppError('点数包不存在', 404);
    }

    // 2. 查询用户信息
    const user = await prisma.user.findUnique({
      where: { id: userId },
    });

    if (!user) {
      throw new AppError('用户不存在', 404);
    }

    // 3. 创建 Stripe Checkout Session
    const session = await stripe.checkout.sessions.create({
      customer_email: user.email,
      payment_method_types: ['card'],
      line_items: [
        {
          price_data: {
            currency: pkg.currency,
            product_data: {
              name: pkg.name,
              description: `充值 ${pkg.credits} 点数`,
            },
            unit_amount: pkg.price,
          },
          quantity: 1,
        },
      ],
      mode: 'payment',
      success_url: `${process.env.FRONTEND_URL}/payment/success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.FRONTEND_URL}/payment/cancel`,
      metadata: {
        userId,
        packageId,
        credits: pkg.credits.toString(),
      },
    });

    // 4. 创建待处理的支付记录
    await prisma.payment.create({
      data: {
        userId,
        amount: pkg.price,
        currency: pkg.currency,
        credits: pkg.credits,
        type: 'ONE_TIME',
        status: 'PENDING',
        stripePaymentId: session.id,
        metadata: { packageId },
      },
    });

    return {
      sessionId: session.id,
      checkoutUrl: session.url!,
    };
  }

  /**
   * 处理 Stripe Webhook
   */
  async handleWebhook(event: Stripe.Event) {
    switch (event.type) {
      case 'checkout.session.completed':
        await this.handleCheckoutCompleted(event.data.object as Stripe.Checkout.Session);
        break;

      case 'invoice.payment_succeeded':
        await this.handleSubscriptionPayment(event.data.object as Stripe.Invoice);
        break;

      case 'customer.subscription.deleted':
        await this.handleSubscriptionCanceled(event.data.object as Stripe.Subscription);
        break;

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }
  }

  /**
   * 处理支付成功
   */
  private async handleCheckoutCompleted(session: Stripe.Checkout.Session) {
    const { userId, credits } = session.metadata!;

    // 1. 更新支付记录
    await prisma.payment.update({
      where: { stripePaymentId: session.id },
      data: { status: 'SUCCEEDED' },
    });

    // 2. 充值点数
    await creditService.addCredits(
      userId,
      parseInt(credits),
      'PURCHASE',
      '购买点数包',
      { sessionId: session.id }
    );

    // 3. 发送确认邮件 (TODO)
    console.log(`Payment succeeded for user ${userId}, added ${credits} credits`);
  }

  /**
   * 处理订阅续费
   */
  private async handleSubscriptionPayment(invoice: Stripe.Invoice) {
    const subscription = await stripe.subscriptions.retrieve(invoice.subscription as string);
    const { userId, plan, credits } = subscription.metadata;

    // 充值月度点数
    await creditService.addCredits(
      userId,
      parseInt(credits),
      'SUBSCRIPTION',
      `订阅续费: ${plan}`,
      { invoiceId: invoice.id }
    );

    console.log(`Subscription renewed for user ${userId}`);
  }

  /**
   * 处理订阅取消
   */
  private async handleSubscriptionCanceled(subscription: Stripe.Subscription) {
    const { userId } = subscription.metadata;

    await prisma.subscription.updateMany({
      where: {
        userId,
        stripeSubscriptionId: subscription.id,
      },
      data: { status: 'CANCELED' },
    });

    console.log(`Subscription canceled for user ${userId}`);
  }
}
```

### 4.4 订阅管理

```typescript
// src/services/subscription.service.ts

import Stripe from 'stripe';
import { prisma } from '../config/database';
import { CreditService } from './credit.service';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);
const creditService = new CreditService();

// 订阅计划配置
const SUBSCRIPTION_PLANS = {
  basic: {
    name: 'Basic',
    price: 999,      // $9.99
    credits: 500,
    stripePriceId: process.env.STRIPE_BASIC_PRICE_ID!,
  },
  pro: {
    name: 'Pro',
    price: 1999,     // $19.99
    credits: 1500,
    stripePriceId: process.env.STRIPE_PRO_PRICE_ID!,
  },
  team: {
    name: 'Team',
    price: 4999,     // $49.99
    credits: 5000,
    stripePriceId: process.env.STRIPE_TEAM_PRICE_ID!,
  },
};

export class SubscriptionService {
  /**
   * 创建订阅
   */
  async createSubscription(userId: string, planId: keyof typeof SUBSCRIPTION_PLANS) {
    const user = await prisma.user.findUnique({ where: { id: userId } });
    if (!user) throw new AppError('用户不存在', 404);

    const plan = SUBSCRIPTION_PLANS[planId];

    // 1. 创建或获取 Stripe Customer
    let customerId = await this.getOrCreateStripeCustomer(user);

    // 2. 创建 Stripe Subscription
    const subscription = await stripe.subscriptions.create({
      customer: customerId,
      items: [{ price: plan.stripePriceId }],
      payment_behavior: 'default_incomplete',
      payment_settings: { save_default_payment_method: 'on_subscription' },
      expand: ['latest_invoice.payment_intent'],
      metadata: {
        userId,
        plan: planId,
        credits: plan.credits.toString(),
      },
    });

    // 3. 保存到数据库
    await prisma.subscription.create({
      data: {
        userId,
        plan: planId.toUpperCase() as any,
        status: 'TRIALING',
        stripeCustomerId: customerId,
        stripeSubscriptionId: subscription.id,
        currentPeriodStart: new Date(subscription.current_period_start * 1000),
        currentPeriodEnd: new Date(subscription.current_period_end * 1000),
      },
    });

    // 4. 立即充值首月点数
    await creditService.addCredits(
      userId,
      plan.credits,
      'SUBSCRIPTION',
      `订阅激活: ${plan.name}`
    );

    const invoice = subscription.latest_invoice as Stripe.Invoice;
    const paymentIntent = invoice.payment_intent as Stripe.PaymentIntent;

    return {
      subscriptionId: subscription.id,
      clientSecret: paymentIntent.client_secret,
    };
  }

  /**
   * 取消订阅
   */
  async cancelSubscription(userId: string) {
    const sub = await prisma.subscription.findFirst({
      where: { userId, status: 'ACTIVE' },
    });

    if (!sub) {
      throw new AppError('没有有效的订阅', 404);
    }

    // 在周期结束时取消
    await stripe.subscriptions.update(sub.stripeSubscriptionId!, {
      cancel_at_period_end: true,
    });

    await prisma.subscription.update({
      where: { id: sub.id },
      data: { cancelAtPeriodEnd: true },
    });

    return {
      cancelAt: sub.currentPeriodEnd,
    };
  }

  /**
   * 获取或创建 Stripe Customer
   */
  private async getOrCreateStripeCustomer(user: any): Promise<string> {
    const existingSub = await prisma.subscription.findFirst({
      where: { userId: user.id },
    });

    if (existingSub?.stripeCustomerId) {
      return existingSub.stripeCustomerId;
    }

    const customer = await stripe.customers.create({
      email: user.email,
      name: user.name,
      metadata: { userId: user.id },
    });

    return customer.id;
  }
}
```

---

## 五、安全方案

### 5.1 认证与授权

#### JWT 配置
```typescript
// src/utils/jwt.ts

import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET!;
const JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET!;

export function generateTokens(user: any) {
  const token = jwt.sign(
    { userId: user.id, email: user.email, role: user.role },
    JWT_SECRET,
    { expiresIn: '15m' }  // Access Token 15 分钟
  );

  const refreshToken = jwt.sign(
    { userId: user.id },
    JWT_REFRESH_SECRET,
    { expiresIn: '7d' }   // Refresh Token 7 天
  );

  return { token, refreshToken };
}

export function verifyToken(token: string) {
  return jwt.verify(token, JWT_SECRET);
}
```

#### 认证中间件
```typescript
// src/middleware/auth.middleware.ts

import { Request, Response, NextFunction } from 'express';
import { verifyToken } from '../utils/jwt';
import { AppError } from '../utils/errors';

export const authenticate = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader?.startsWith('Bearer ')) {
      throw new AppError('未授权', 401);
    }

    const token = authHeader.substring(7);
    const decoded = verifyToken(token) as any;

    // 检查 token 是否在黑名单 (已登出)
    const session = await prisma.session.findUnique({
      where: { token },
    });

    if (!session) {
      throw new AppError('Token 已失效', 401);
    }

    req.user = decoded;
    next();
  } catch (error) {
    next(new AppError('认证失败', 401));
  }
};

export const authorize = (...roles: string[]) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (!roles.includes(req.user.role)) {
      return next(new AppError('权限不足', 403));
    }
    next();
  };
};
```

### 5.2 API 限流

```typescript
// src/middleware/rateLimit.middleware.ts

import rateLimit from 'express-rate-limit';
import RedisStore from 'rate-limit-redis';
import { redisClient } from '../config/redis';

// 全局限流: 100 请求/分钟
export const globalLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 100,
  store: new RedisStore({
    client: redisClient,
    prefix: 'ratelimit:global:',
  }),
  message: '请求过于频繁,请稍后再试',
});

// 登录限流: 5 次/分钟
export const authLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 5,
  skipSuccessfulRequests: true,
  store: new RedisStore({
    client: redisClient,
    prefix: 'ratelimit:auth:',
  }),
});

// 订阅用户更高限额: 500 请求/分钟
export const subscriberLimiter = (req: Request, res: Response, next: NextFunction) => {
  const limit = req.user?.role === 'SUBSCRIBER' ? 500 : 100;

  return rateLimit({
    windowMs: 60 * 1000,
    max: limit,
    store: new RedisStore({
      client: redisClient,
      prefix: `ratelimit:user:${req.user?.userId}:`,
    }),
  })(req, res, next);
};
```

### 5.3 输入验证

```typescript
// src/middleware/validation.middleware.ts

import { body, param, query, validationResult } from 'express-validator';
import { Request, Response, NextFunction } from 'express';
import { AppError } from '../utils/errors';

export const validate = (req: Request, res: Response, next: NextFunction) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    throw new AppError('验证失败', 400, errors.array());
  }
  next();
};

// 示例验证规则
export const createPaymentValidation = [
  body('packageId').isUUID().withMessage('packageId 必须是 UUID'),
  validate,
];

export const deductCreditsValidation = [
  body('amount').isInt({ min: 1 }).withMessage('amount 必须是正整数'),
  body('feature').isString().notEmpty().withMessage('feature 不能为空'),
  validate,
];
```

### 5.4 CORS 配置

```typescript
// src/app.ts

import cors from 'cors';

app.use(
  cors({
    origin: process.env.FRONTEND_URL,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization'],
  })
);
```

### 5.5 Helmet 安全头

```typescript
import helmet from 'helmet';

app.use(helmet());
app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    scriptSrc: ["'self'"],
    imgSrc: ["'self'", 'data:', 'https:'],
  },
}));
```

---

## 六、部署方案

### 6.1 环境变量配置

```bash
# .env.example

# 服务配置
NODE_ENV=production
PORT=3000
API_URL=https://api.skywork.ai

# 数据库
DATABASE_URL=mysql://user:password@localhost:3306/skywork_db

# Redis
REDIS_URL=redis://localhost:6379

# MongoDB
MONGODB_URI=mongodb://localhost:27017/skywork_logs

# JWT
JWT_SECRET=your-super-secret-key-change-this
JWT_REFRESH_SECRET=your-refresh-secret-key-change-this

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Stripe
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_BASIC_PRICE_ID=price_...
STRIPE_PRO_PRICE_ID=price_...
STRIPE_TEAM_PRICE_ID=price_...

# 前端 URL
FRONTEND_URL=https://app.skywork.ai

# 日志
LOG_LEVEL=info
```

### 6.2 Docker 部署

```dockerfile
# Dockerfile

FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm ci

COPY . .

RUN npx prisma generate
RUN npm run build

FROM node:20-alpine

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/prisma ./prisma
COPY package*.json ./

EXPOSE 3000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml

version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: skywork_db
    volumes:
      - mysql-data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  mysql-data:
  redis-data:
```

### 6.3 CI/CD (GitHub Actions)

```yaml
# .github/workflows/deploy.yml

name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Deploy to Railway
        run: railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

---

## 七、开发规范

### 7.1 代码风格

```json
// .eslintrc.json
{
  "extends": ["airbnb-typescript/base"],
  "parserOptions": {
    "project": "./tsconfig.json"
  },
  "rules": {
    "no-console": "off",
    "import/prefer-default-export": "off"
  }
}
```

```json
// .prettierrc
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

### 7.2 Git 提交规范

```
feat: 新功能
fix: 修复 bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具链更新
```

---

## 八、总结

本技术方案涵盖了 Skywork AI Agent 后端系统的完整设计,包括:

✅ **系统架构**: Express + TypeScript + Prisma + MySQL + Redis
✅ **核心功能**: Google OAuth、点数系统、订阅管理、Stripe 支付
✅ **安全方案**: JWT 认证、API 限流、输入验证、HTTPS 加密
✅ **数据库设计**: 完整的 Prisma Schema 和索引优化
✅ **API 设计**: RESTful API 规范,详细的接口文档
✅ **部署方案**: Docker 容器化,CI/CD 自动部署

**预计开发周期**: 6-8 周
**技术难度**: ⭐⭐⭐⭐ (中高)
**可扩展性**: ⭐⭐⭐⭐⭐ (优秀)

---

**文档编写**: Claude AI
**下一步行动**: 开始编码实现 MVP 版本
